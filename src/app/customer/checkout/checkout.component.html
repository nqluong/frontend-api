<!-- Start main-content -->
<section class="page-title" style="background-image: url(assets/customer/images/background/page-title-bg.png);">
    <div class="auto-container">
        <div class="title-outer text-center">
            <h1 class="title">Đặt Phòng & Thanh Toán</h1>
            <ul class="page-breadcrumb">
                <li><a routerLink="/customer">Trang Chủ</a></li>
                <li>Thanh Toán</li>
            </ul>
        </div>
    </div>
</section>
<!-- end main-content -->

<!-- Booking Info Section -->
<section class="booking-info pt-60 pb-0" *ngIf="bookingId">
    <div class="auto-container">
        <div class="sec-title text-center" *ngIf="step === 'info'">
            <span class="sub-title">THÔNG TIN ĐẶT PHÒNG</span>
            <h2>Hoàn Thành Thông Tin Cá Nhân</h2>
        </div>
        <div class="sec-title text-center" *ngIf="step === 'payment'">
            <span class="sub-title">THÔNG TIN ĐẶT PHÒNG</span>
            <h2>Xác Nhận & Thanh Toán</h2>
        </div>
        <div class="booking-info-box text-center mb-30">
            <div class="info-item">
                <h4>Mã đặt phòng</h4>
                <p>#{{bookingId}}</p>
            </div>
            <div class="info-item">
                <h4>Tên phòng</h4>
                <p>{{roomName || 'Chưa có thông tin'}}</p>
            </div>
            <div class="info-item">
                <h4>Ngày nhận phòng</h4>
                <p>{{checkIn ? (checkIn | date:'dd/MM/yyyy') : 'Chưa có thông tin'}}</p>
            </div>
            <div class="info-item">
                <h4>Ngày trả phòng</h4>
                <p>{{checkOut ? (checkOut | date:'dd/MM/yyyy') : 'Chưa có thông tin'}}</p>
            </div>
        </div>
    </div>
</section>

<!-- Loading Indicators -->
<div class="text-center py-5" *ngIf="isSubmittingInfo || isLoadingPaymentDetails || isCreatingAccount">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Đang xử lý...</span>
    </div>
    <p class="mt-2" *ngIf="isSubmittingInfo && !isCreatingAccount">Đang gửi thông tin cá nhân...</p>
    <p class="mt-2" *ngIf="isCreatingAccount && !accountCreationSuccess">Đang tạo tài khoản...</p>
    <p class="mt-2 text-success" *ngIf="isCreatingAccount && accountCreationSuccess">
        <i class="fa fa-check-circle"></i> {{accountCreationMessage}}
    </p>
    <p class="mt-2" *ngIf="isLoadingPaymentDetails">Đang tải thông tin thanh toán...</p>
</div>

<!-- Customer Info Form -->
<section class="customer-info-section pt-60 pb-90" *ngIf="step === 'info' && !isSubmittingInfo && !isLoadingPaymentDetails">
    <div class="auto-container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="customer-form-box">
                    <div class="form-header">
                        <h3>Thông Tin Cá Nhân</h3>
                        <p>Vui lòng điền đầy đủ thông tin để hoàn tất đặt phòng</p>
                        <div class="alert alert-info mt-3">
                            <small>Thông tin của bạn sẽ được lưu tạm thời và chỉ được gửi lên hệ thống sau khi thanh toán thành công.</small>
                        </div>
                        
                        <!-- Account creation success message -->
                        <div class="alert alert-success mt-3" *ngIf="accountCreationSuccess">
                            <i class="fa fa-check-circle mr-2"></i> {{accountCreationMessage}}
                        </div>
                        
                        <!-- General error message -->
                        <div class="alert alert-danger mt-3" *ngIf="validationErrors.general">
                            <i class="fa fa-exclamation-circle mr-2"></i> {{validationErrors.general}}
                        </div>
                        
                        <!-- Account creation error summary -->

                    </div>
                    <form (ngSubmit)="submitCustomerInfo()">
                        <div class="row">
                            <div class="col-md-12 mb-4">
                                <div class="form-group">
                                    <label for="fullName">Họ và tên <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="fullName" [(ngModel)]="customerInfo.fullName" name="fullName" required>
                                    <small class="form-text text-muted">Vui lòng nhập đầy đủ họ và tên. Hệ thống sẽ tự động tách thành họ và tên riêng.</small>
                                    <div class="invalid-feedback" *ngIf="formSubmitted && !customerInfo.fullName">
                                        Vui lòng nhập họ và tên
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="form-group">
                                    <label for="dateOfBirth">Ngày sinh <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="dateOfBirth" [(ngModel)]="customerInfo.dateOfBirth" name="dateOfBirth" required>
                                    <div class="invalid-feedback" *ngIf="formSubmitted && !customerInfo.dateOfBirth">
                                        Vui lòng chọn ngày sinh
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="form-group">
                                    <label for="gender">Giới tính <span class="text-danger">*</span></label>
                                    <select class="form-control" id="gender" [(ngModel)]="customerInfo.gender" name="gender" required>
                                        <option value="Nam">Nam</option>
                                        <option value="Nữ">Nữ</option>
                                        <option value="Khac">Khác</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="form-group">
                                    <label for="email">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="email" [(ngModel)]="customerInfo.email" name="email" required
                                           [ngClass]="{'is-invalid': validationErrors.email || (formSubmitted && !customerInfo.email)}">
                                    <div class="invalid-feedback" *ngIf="validationErrors.email">
                                        {{validationErrors.email}}
                                    </div>
                                    <div class="invalid-feedback" *ngIf="!validationErrors.email && formSubmitted && !customerInfo.email">
                                        Vui lòng nhập email
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="form-group">
                                    <label for="phone">Số điện thoại <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="phone" [(ngModel)]="customerInfo.phone" name="phone" required
                                           [ngClass]="{'is-invalid': validationErrors.phone || (formSubmitted && !customerInfo.phone)}">
                                    <div class="invalid-feedback" *ngIf="validationErrors.phone">
                                        {{validationErrors.phone}}
                                    </div>
                                    <div class="invalid-feedback" *ngIf="!validationErrors.phone && formSubmitted && !customerInfo.phone">
                                        Vui lòng nhập số điện thoại
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-12 mb-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="createAccount" [(ngModel)]="customerInfo.createAccount" name="createAccount">
                                    <label class="form-check-label" for="createAccount">
                                        Tạo tài khoản để dễ dàng đặt phòng lần sau
                                    </label>
                                    <div class="small text-info mt-1" *ngIf="customerInfo.createAccount">
                                        <i class="fa fa-info-circle"></i> Tài khoản sẽ được tạo ngay lập tức để đảm bảo không có lỗi khi thanh toán.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4" *ngIf="customerInfo.createAccount">
                                <div class="form-group">
                                    <label for="username">Tên đăng nhập <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="username" [(ngModel)]="customerInfo.username" name="username" required
                                           [ngClass]="{'is-invalid': validationErrors.username || (formSubmitted && customerInfo.createAccount && !customerInfo.username)}">
                                    <div class="invalid-feedback" *ngIf="validationErrors.username">
                                        {{validationErrors.username}}
                                    </div>
                                    <div class="invalid-feedback" *ngIf="!validationErrors.username && formSubmitted && customerInfo.createAccount && !customerInfo.username">
                                        Vui lòng nhập tên đăng nhập
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4" *ngIf="customerInfo.createAccount">
                                <div class="form-group">
                                    <label for="password">Mật khẩu <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="password" [(ngModel)]="customerInfo.password" name="password" required
                                           [ngClass]="{'is-invalid': validationErrors.password || (formSubmitted && customerInfo.createAccount && (!customerInfo.password || customerInfo.password.length < 6))}">
                                    <div class="invalid-feedback" *ngIf="validationErrors.password">
                                        {{validationErrors.password}}
                                    </div>
                                    <div class="invalid-feedback" *ngIf="!validationErrors.password && formSubmitted && customerInfo.createAccount && (!customerInfo.password || customerInfo.password.length < 6)">
                                        Mật khẩu phải có ít nhất 6 ký tự
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-12 text-center mt-3">
                                <button type="submit" class="theme-btn btn-style-one" [disabled]="isSubmittingInfo || isCreatingAccount">
                                    <span class="btn-title" *ngIf="!isSubmittingInfo && !isCreatingAccount">Tiếp tục đến thanh toán</span>
                                    <span class="btn-title" *ngIf="isSubmittingInfo || isCreatingAccount">
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span *ngIf="isCreatingAccount">Đang kiểm tra và tạo tài khoản...</span>
                                        <span *ngIf="isSubmittingInfo && !isCreatingAccount">Đang xử lý thông tin...</span>
                                    </span>
                                </button>
                                <button type="button" class="theme-btn btn-style-three ms-2" (click)="cancelBooking()">
                                    <span class="btn-title">Hủy đặt phòng</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Payment Details Section -->
<section class="payment-section pt-60 pb-90" *ngIf="step === 'payment' && paymentDetails && !isSubmittingInfo && !isLoadingPaymentDetails">
    <div class="auto-container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="payment-details-box">
                    <div class="details-header">
                        <h3>Chi Tiết Thanh Toán</h3>
                        <p>Vui lòng kiểm tra thông tin thanh toán trước khi hoàn tất</p>
                    </div>
                    
                    <div class="details-content">
                        <div class="room-details">
                            <h4>Thông tin phòng</h4>
                            <div class="item-row">
                                <span class="item-label">Tên phòng:</span>
                                <span class="item-value">{{paymentDetails.phongInfo || paymentDetails.roomName}}</span>
                            </div>
                            <div class="item-row">
                                <span class="item-label">Ngày nhận phòng:</span>
                                <span class="item-value">{{checkIn | date:'dd/MM/yyyy'}}</span>
                            </div>
                            <div class="item-row">
                                <span class="item-label">Ngày trả phòng:</span>
                                <span class="item-value">{{checkOut | date:'dd/MM/yyyy'}}</span>
                            </div>
                            <div class="item-row">
                                <span class="item-label">Số ngày:</span>
                                <span class="item-value">{{paymentDetails.soNgayThue || paymentDetails.totalDays}}</span>
                            </div>
                            <div class="item-row">
                                <span class="item-label">Giá phòng:</span>
                                <span class="item-value">{{formatCurrency(paymentDetails.giaPhong ?? paymentDetails.roomPrice ?? 0)}} / đêm</span>
                            </div>
                            <div class="item-row total-row">
                                <span class="item-label">Thành tiền phòng:</span>
                                <span class="item-value">{{formatCurrency(paymentDetails.tongTienPhong ?? (paymentDetails.roomPrice && paymentDetails.totalDays ? paymentDetails.roomPrice * paymentDetails.totalDays : 0))}}</span>
                            </div>
                        </div>
                        
                        <div class="services-details" *ngIf="(paymentDetails.dichVuList && paymentDetails.dichVuList.length > 0) || (paymentDetails.services && paymentDetails.services.length > 0)">
                            <h4>Dịch vụ đã chọn</h4>
                            <div class="services-table">
                                <div class="table-header">
                                    <div class="col-name">Tên dịch vụ</div>
                                    <div class="col-price">Giá</div>
                                    <div class="col-qty">SL</div>
                                    <div class="col-total">Thành tiền</div>
                                </div>
                                
                                <!-- Sử dụng dichVuList nếu có -->
                                <div class="table-row" *ngFor="let service of paymentDetails.dichVuList">
                                    <div class="col-name">{{service.tenDv}}</div>
                                    <div class="col-price">{{formatCurrency(service.gia)}}</div>
                                    <div class="col-qty">{{service.soLuong}}</div>
                                    <div class="col-total">{{formatCurrency(service.thanhTien)}}</div>
                                </div>
                                
                                <!-- Sử dụng services nếu có -->
                                <div class="table-row" *ngFor="let service of paymentDetails.services">
                                    <div class="col-name">{{service.serviceName}}</div>
                                    <div class="col-price">{{formatCurrency(service.price)}}</div>
                                    <div class="col-qty">{{service.quantity}}</div>
                                    <div class="col-total">{{formatCurrency(service.total)}}</div>
                                </div>
                                
                                <div class="table-footer">
                                    <span>Tổng tiền dịch vụ:</span>
                                    <span>{{formatCurrency(paymentDetails.tongTienDichVu ?? paymentDetails.totalServiceAmount ?? 0)}}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="total-amount">
                            <div class="total-row">
                                <span class="total-label">Tổng số tiền thanh toán:</span>
                                <span class="total-value">{{formatCurrency(paymentDetails.tongTienThanhToan ?? paymentDetails.totalAmount ?? 0)}}</span>
                            </div>
                        </div>
                        
                        <div class="payment-actions text-center mt-5">
                            <div class="payment-notice mb-3">
                                <small class="text-muted">Khi bấm "Thanh toán ngay", bạn sẽ được chuyển đến trang thanh toán VNPay và sau đó trở lại trang kết quả.</small>
                            </div>
                            <button class="theme-btn btn-style-one me-3" (click)="createPayment()" [disabled]="isCreatingPayment">
                                <span class="btn-title" *ngIf="!isCreatingPayment">Thanh toán ngay</span>
                                <span class="btn-title" *ngIf="isCreatingPayment">Đang xử lý...</span>
                            </button>
                            <button class="theme-btn btn-style-two" (click)="cancelBooking()">
                                <span class="btn-title">Hủy đặt phòng</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- No Booking Info Section -->
<section class="no-booking-section pt-60 pb-90" *ngIf="!bookingId">
    <div class="auto-container">
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center">
                <div class="error-box">
                    <div class="error-icon">
                        <i class="fa fa-exclamation-circle"></i>
                    </div>
                    <h3>Không tìm thấy thông tin đặt phòng</h3>
                    <p>Có vẻ như bạn chưa có phòng nào được đặt. Vui lòng quay lại trang chủ để tìm kiếm và đặt phòng.</p>
                    <a routerLink="/customer" class="theme-btn btn-style-one mt-4">
                        <span class="btn-title">Quay lại trang chủ</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>